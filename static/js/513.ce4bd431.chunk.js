"use strict";(self.webpackChunkcontracts=self.webpackChunkcontracts||[]).push([[513],{453:(e,t,o)=>{o.d(t,{S:()=>n,h:()=>a});const n=e=>{if(!e)return"";let t=e.toLowerCase();t=t.replace(/\u0430/g,"a"),t=t.replace(/\u0441/g,"c"),t=t.replace(/\u0435/g,"e"),t=t.replace(/\u043e/g,"o"),t=t.replace(/\u0440/g,"p");const o=t.replace(/[^a-z0-9]/g,""),n=(o.match(/[a-z]/g)||[]).sort().join("");return(o.match(/[0-9]/g)||[]).join("")+n},a=e=>{if(!e)return"";let t=e.replace(/\D/g,"");return t.startsWith("05")&&10===t.length?"971".concat(t.substring(1)):(t.startsWith("971")&&t.length,t)}},513:(e,t,o)=>{o.r(t),o.d(t,{default:()=>q});var n=o(555),a=o(43),r=o(368);function s(e){var t,o,n="";if("string"==typeof e||"number"==typeof e)n+=e;else if("object"==typeof e)if(Array.isArray(e)){var a=e.length;for(t=0;t<a;t++)e[t]&&(o=s(e[t]))&&(n&&(n+=" "),n+=o)}else for(o in e)e[o]&&(n&&(n+=" "),n+=o);return n}const c=function(){for(var e,t,o=0,n="",a=arguments.length;o<a;o++)(e=arguments[o])&&(t=s(e))&&(n&&(n+=" "),n+=t);return n};var l=o(950),i=o(453);const d=e=>{if(!e||""===e.trim())return"";let t=e.toString();const o=t.match(/^(\d{1,2}[-\/]\d{1,2}[-\/]\d{4})(\d{4})?/);return t=o?o[1]:t.split(" ")[0],t.includes("-")?t.replace(/-/g,"/"):t},u=e=>{if(!e||""===e.trim())return null;const t=e.replace(/\//g,"-").split("-");if(3!==t.length){const t=new Date(e);return isNaN(t.getTime())?null:t}let[o,n,a]=t.map(e=>parseInt(e,10));if(isNaN(o)||isNaN(n)||isNaN(a)){const t=new Date(e);return isNaN(t.getTime())?null:t}a<100&&(a+=2e3);const r=new Date(Date.UTC(a,n-1,o));return isNaN(r.getTime())?null:r},p=(e,t)=>{if(!e||!t||!e.invygoPlate)return null;const o=t.filter(t=>(0,i.S)(t.Vehicle)===(0,i.S)(e.invygoPlate));if(0===o.length)return null;const n=o.map(e=>u(e["Date IN"])).filter(Boolean),a=o.map(e=>u(e["Date OUT"])).filter(Boolean);if(0===n.length)return null;const r=new Date(Math.max(...n.map(e=>e.getTime()))),s=a.length>0?new Date(Math.max(...a.map(e=>e.getTime()))):null;return s&&s.getTime()>r.getTime()?null:r},h=e=>{const t=!isNaN(Number(e.bookingNumber)),o=(0,i.S)(e.ejarPlate),n=(0,i.S)(e.invygoPlate);return t&&o&&n&&o!==n};var m=o(579);const g=e=>{let{row:t,maintenanceData:o,onCopy:n}=e;const[r,s]=(0,a.useState)(!1),[c,d]=(0,a.useState)({top:0,left:0}),u=(0,a.useRef)(null);(0,a.useEffect)(()=>{if(r){const e=()=>s(!1);return window.addEventListener("scroll",e,!0),()=>window.removeEventListener("scroll",e,!0)}},[r]);const g=(e,t,o)=>{const a=(0,i.h)(e.phoneNumber),r=t.replace("#XXXXXX","#".concat(e.bookingNumber));n(r,o),window.open("https://wa.me/".concat(a),"_blank")},b=[{label:"1 - Open WhatsApp",action:()=>window.open("https://wa.me/".concat((0,i.h)(t.phoneNumber)),"_blank")},{label:"2 - Welcome Message",action:()=>{g(t,"Good day,\n\nThis is Mohamed from Invygo \u2013 Yelo Rent A Car. Regarding your booking (#XXXXXX), we have received a service request for the car.\n\nTo assist you as quickly as possible, please provide:\n\n* A photo of the car\u2019s current mileage (KM)\n\n* A photo of the maintenance sticker once open driver door\n\n* or details of the issue (if available)\n\nWe are here to serve you, Thank you.","Welcome message copied!")}},...h(t)&&p(t,o)?[{label:"3 - Switch Back Request",action:()=>{g(t,"Good day, this is Mohamed from Invygo \u2013 Yelo Rent A Car. Your original car is ready, and we need to switch it back as per your booking (#XXXXXX). Please let me know a suitable time today and share your location. Thank you!","Switch back request copied!")}}]:[],{label:"".concat(h(t)&&p(t,o)?"4":"3"," - Close Complaint"),action:()=>{g(t,"now i will close the request maybe you will receive schedule email please ignore it, as we need to schedule a service in order to close it in the system.","Complaint closing message copied!")}}],f=r?(0,m.jsxs)("div",{style:{position:"absolute",top:0,left:0,width:"100%",height:"100%",zIndex:9999},children:[(0,m.jsx)("div",{style:{position:"fixed",top:0,left:0,right:0,bottom:0},onClick:()=>s(!1)}),(0,m.jsx)("div",{style:{position:"absolute",top:c.top,left:c.left,transform:c.isUp?"translateY(-100%)":"none",zIndex:1e4,background:"white",border:"1px solid #ccc",borderRadius:4,boxShadow:"0 2px 10px rgba(0,0,0,0.2)",minWidth:200},children:b.map((e,t)=>(0,m.jsx)("button",{onClick:t=>{t.stopPropagation(),e.action(),s(!1)},style:{display:"block",width:"100%",padding:"8px 12px",border:"none",background:"none",textAlign:"left",cursor:"pointer",borderBottom:t<b.length-1?"1px solid #eee":"none"},type:"button",children:e.label},t))})]}):null;return(0,m.jsxs)(m.Fragment,{children:[(0,m.jsx)("button",{ref:u,className:"phone-link",onClick:e=>{e.stopPropagation(),(()=>{if(!r&&u.current){const e=u.current.getBoundingClientRect(),t=window.innerHeight-e.bottom<200;d({top:t?e.top+window.scrollY-5:e.bottom+window.scrollY+5,left:e.left+window.scrollX,isUp:t})}s(!r)})()},type:"button","aria-haspopup":"true","aria-expanded":r,children:t.phoneNumber}),r&&l.createPortal(f,document.body)]})},b=e=>{let{headers:t,visibleColumns:o,setVisibleColumns:n,setShowColumnMenu:a,headerDisplayNames:r}=e;return(0,m.jsxs)("div",{style:{position:"absolute",top:"100%",left:0,zIndex:200,background:"white",border:"1px solid #ccc",borderRadius:4,boxShadow:"0 4px 12px rgba(0,0,0,0.15)",padding:10,maxHeight:300,overflowY:"auto",minWidth:200},onClick:e=>e.stopPropagation(),children:[(0,m.jsxs)("div",{style:{fontWeight:"bold",marginBottom:6,display:"flex",justifyContent:"space-between",alignItems:"center"},children:[(0,m.jsx)("span",{children:"Show Columns"}),(0,m.jsx)("button",{onClick:()=>a(!1),style:{border:"none",background:"none",cursor:"pointer",fontWeight:"bold"},children:"X"})]}),t.map(e=>(0,m.jsx)("div",{style:{padding:"4px 0"},children:(0,m.jsxs)("label",{style:{display:"flex",alignItems:"center",cursor:"pointer"},children:[(0,m.jsx)("input",{type:"checkbox",checked:!o||o.includes(e),onChange:a=>((e,a)=>{e.stopPropagation();let r=[...o||t];r.includes(a)?r=r.filter(e=>e!==a):(r.push(a),r.sort((e,o)=>t.indexOf(e)-t.indexOf(o))),n(r)})(a,e),style:{marginRight:8}}),r[e]||e]})},e))]})},f=e=>{let{data:t,headers:o,visibleColumns:n,columnWidths:a,onColumnResize:r,onToggleColumnMenu:s,showColumnMenu:l,setShowColumnMenu:u,setVisibleColumns:f,headerDisplayNames:y,duplicatedContractsInfo:C,maintenanceData:x,isCarExpired:v,getExpiryDate:k,getIssueForRow:w,onCustomerClick:S,onCopy:N}=e;const j=n?o.filter(e=>n.includes(e)):o,D=e=>"contractNo"===e?"col-contract":"bookingNumber"===e?"col-booking":"customer"===e?"col-customer":"invygoModel"===e||"ejarModel"===e||"model1"===e?"col-model":"invygoPlate"===e||"ejarPlate"===e||"plateNo1"===e||"plateNo2"===e?"col-plate":["pickupDate","dropoffDate","replacementDate","revenueDate"].includes(e)?"col-date":"phoneNumber"===e?"col-phone":"pickupBranch"===e?"col-branch":"contact"===e?"col-contact":"contractType"===e?"col-type":"";return(0,m.jsx)("div",{className:"dashboard-table-wrapper",children:(0,m.jsxs)("table",{className:"dashboard-table",children:[(0,m.jsx)("thead",{children:(0,m.jsxs)("tr",{children:[(0,m.jsx)("th",{className:"col-index",children:(0,m.jsxs)("div",{style:{display:"flex",alignItems:"center",justifyContent:"center"},children:["#",(0,m.jsx)("button",{style:{marginLeft:6,cursor:"pointer",background:"none",border:"none",fontSize:16},title:"Columns",type:"button",onClick:e=>{e.stopPropagation(),s()},children:"\u2699\ufe0f"}),l&&(0,m.jsx)(b,{headers:o,visibleColumns:n,setVisibleColumns:f,setShowColumnMenu:u,headerDisplayNames:y})]})}),j.map(e=>(0,m.jsx)("th",{className:D(e),children:y[e]||e},e))]})}),(0,m.jsx)("tbody",{children:t.map((e,t)=>{var o;const n=(0,i.S)(e.invygoPlate),a=(null===(o=C[n])||void 0===o?void 0:o.length)>1,r="open"===e.type&&h(e),s=r&&p(e,x),l=[e.ejarPlate,e.invygoPlate,e.plateNo1,e.plateNo2].filter(Boolean),u="open"===e.type&&l.some(e=>v(e)),b=(u&&k(n),c({"row-duplicated":a,"row-mismatch":r&&!u,"row-repaired":s,"row-expired":u,"row-even":t%2===0,"row-odd":t%2!==0}));return(0,m.jsxs)("tr",{className:b,children:[(0,m.jsx)("td",{className:"col-index",children:(0,m.jsx)("button",{type:"button",onClick:()=>{if("open"!==e.type)return;const t=(e.customer||"").split(" ")[0],o=e.phoneNumber||"";let n;n=h(e)&&p(e,x)?"".concat(e.bookingNumber," - Switch Back\n\n").concat(t," - ").concat(o,"\n\nOld car / ").concat(e.ejarModel," - ").concat(e.ejarPlate,"\n\nNew car / ").concat(e.invygoModel," - ").concat(e.invygoPlate):"".concat(e.bookingNumber," - Switch\n\n").concat(t," - ").concat(o,"\n\nOld car / ").concat(e.ejarModel," - ").concat(e.ejarPlate,"\n\nNew car /"),N(n,"WhatsApp message copied!")},className:"table-action-btn",style:{border:"none",background:"none",fontWeight:"bold",fontSize:"inherit",color:"inherit"},children:(void 0!==e.originalIndex?e.originalIndex:t)+1})}),j.map(t=>{let o=e[t];const n=e[t],r=D(t);if(["pickupDate","dropoffDate","replacementDate","revenueDate"].includes(t))o=d(n);else if("contractNo"===t)o=(0,m.jsxs)("div",{style:{display:"flex",alignItems:"center",gap:5,justifyContent:"center"},children:[(0,m.jsx)("a",{href:"https://ejar.iyelo.com:6300/app/rental/contracts",onClick:e=>{e.preventDefault(),N(n,"Contract ".concat(n," copied!")),window.open(e.currentTarget.href,"_blank")},className:"table-link",style:{color:"inherit"},children:n}),a&&(0,m.jsx)("span",{title:"Duplicated Contract",children:"\u26a0\ufe0f"})]});else if("bookingNumber"===t)o=(0,m.jsx)("a",{href:"https://dashboard.invygo.com/bookings",onClick:e=>{e.preventDefault(),N(n,"Booking ".concat(n," copied!")),window.open(e.currentTarget.href,"_blank")},className:"table-link",style:{color:"inherit"},children:n});else if("customer"===t)o=(0,m.jsx)("button",{type:"button",onClick:()=>S(e),className:"table-link",style:{background:"none",border:"none",fontSize:"inherit",cursor:"pointer",padding:0,textDecoration:"underline",color:"inherit"},children:n});else if("phoneNumber"===t&&"open"===e.type)o=(0,m.jsx)(g,{row:e,maintenanceData:x,onCopy:N});else if("ejarPlate"===t||"invygoPlate"===t){const a=n||("invygoPlate"===t?e.ejarPlate:""),r=v(a),s=k(a),c=(0,i.S)(a),l=C[c],u=null===l||void 0===l?void 0:l.find(t=>t.contractNo!==e.contractNo);o=(0,m.jsxs)("span",{children:[a," ",r&&"\u26a0\ufe0f",r&&(0,m.jsxs)("div",{style:{fontSize:"0.8em"},children:["Exp: ",d(s)]}),u&&(0,m.jsxs)("div",{style:{fontSize:"0.8em",color:"#fff",backgroundColor:"#d32f2f",padding:"2px 4px",borderRadius:4,marginTop:4,fontWeight:"bold",cursor:"pointer"},onClick:e=>{e.stopPropagation(),N(u.contractNo,"Contract ".concat(u.contractNo," copied!"))},title:"Click to copy contract number",children:["\u26a0\ufe0f Rented to: ",u.customer]})]})}else if("invygoModel"===t){const t=n||e.ejarModel,a=s?((e,t)=>{const o=p(e,t);if(!o)return"";const n=(new Date).getTime()-o.getTime(),a=Math.floor(n/864e5);return a>=0?a:""})(e,x):"";o=(0,m.jsxs)("span",{children:[t,s&&(0,m.jsxs)("div",{className:"repaired-info",children:["Repaired: ",a," days ago"]})]})}else if("issue"===t)o=w(e,x);else if("contractType"===t){o={open:"Open",closed_invygo:"Closed (Invygo)",closed_other:"Closed (Other)"}[e.type]||e.type}return(0,m.jsx)("td",{className:r,title:"string"===typeof o?o:void 0,children:o},t)})]},t)})})]})})},y=(0,a.memo)(f);function C(e){let{message:t,show:o}=e;return o?(0,m.jsx)("div",{style:{position:"fixed",bottom:"20px",left:"50%",transform:"translateX(-50%)",backgroundColor:"#28a745",color:"white",padding:"12px 24px",borderRadius:"8px",zIndex:1e4,boxShadow:"0 4px 12px rgba(0,0,0,0.15)",transition:"opacity 0.5s"},children:t}):null}const x=e=>{let{contract:t,onClose:o}=e;const n=(0,a.useRef)(null),r=(0,a.useRef)(null);if((0,a.useEffect)(()=>{var e;const t=e=>{if("Escape"===e.key&&o(),"Tab"===e.key){const t=n.current.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'),o=t[0],a=t[t.length-1];e.shiftKey&&document.activeElement===o?(e.preventDefault(),a.focus()):e.shiftKey||document.activeElement!==a||(e.preventDefault(),o.focus())}};return document.addEventListener("keydown",t),null===(e=r.current)||void 0===e||e.focus(),()=>document.removeEventListener("keydown",t)},[o]),!t)return null;const s=[{label:"Contract No.",key:e=>e.contractNo||e["Contract No."]},{label:"Booking Number",key:e=>e.bookingNumber||e["Booking Number"]},{label:"Customer",key:e=>e.customer||e["Customer Name"]},{label:"Phone",key:e=>e.phoneNumber||e["Phone Number"]},{label:"Type",key:e=>e.contractType||e.type},{label:"Status",key:e=>e.status||"Active"},{label:"Invygo Model",key:e=>e.invygoModel||e.Model},{label:"Invygo Plate",key:e=>e.invygoPlate||e.INVYGO},{label:"Ejar Model",key:e=>e.ejarModel||e["Model ( Ejar )"]},{label:"Ejar Plate",key:e=>e.ejarPlate||e.EJAR},{label:"Pick-up Date",key:e=>d(e.pickupDate||e["Pick-up Date"])},{label:"Drop-off Date",key:e=>d(e.dropoffDate||e["Drop-off Date"])},{label:"Replacement Date",key:e=>d(e.replacementDate||e["Replacement Date"])},{label:"Pick-up Branch",key:e=>e.pickupBranch||e["Pick-up Branch"]}].filter(e=>e.key(t));return(0,m.jsx)("div",{style:{position:"fixed",top:0,left:0,right:0,bottom:0,backgroundColor:"rgba(0, 0, 0, 0.7)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:1e3},onClick:o,onKeyDown:e=>{"Escape"===e.key&&o()},role:"button",tabIndex:-1,children:(0,m.jsxs)("div",{style:{backgroundColor:"#fff",padding:"24px",borderRadius:"12px",maxWidth:"600px",width:"90%",maxHeight:"90vh",overflowY:"auto",boxShadow:"0 4px 20px rgba(0,0,0,0.2)",cursor:"default"},onClick:e=>e.stopPropagation(),ref:n,role:"dialog","aria-modal":"true","aria-labelledby":"modal-title",children:[(0,m.jsxs)("div",{style:{marginBottom:"20px",paddingBottom:"10px",borderBottom:"2px solid #ffd600",display:"flex",justifyContent:"space-between",alignItems:"center"},children:[(0,m.jsx)("h2",{id:"modal-title",style:{margin:0,color:"#6a1b9a"},children:"Contract Details"}),(0,m.jsx)("button",{ref:r,style:{background:"none",border:"none",fontSize:"24px",cursor:"pointer",color:"#6a1b9a"},onClick:o,"aria-label":"Close modal",children:"\xd7"})]}),(0,m.jsxs)("div",{children:[s.map((e,o)=>(0,m.jsxs)("div",{style:{display:"flex",marginBottom:"12px",borderBottom:"1px solid #f0f0f0",paddingBottom:"8px"},children:[(0,m.jsxs)("div",{style:{fontWeight:"bold",width:"180px",color:"#6a1b9a",flexShrink:0},children:[e.label,":"]}),(0,m.jsx)("div",{style:{flexGrow:1,wordBreak:"break-word"},children:e.key(t)})]},o)),t.issue&&(0,m.jsxs)("div",{style:{display:"flex",marginBottom:"12px",color:"red"},children:[(0,m.jsx)("div",{style:{fontWeight:"bold",width:"180px"},children:"Reported Issue:"}),(0,m.jsx)("div",{style:{fontWeight:"bold"},children:t.issue})]})]}),(0,m.jsx)("div",{style:{textAlign:"right",marginTop:"20px"},children:(0,m.jsx)("button",{onClick:o,style:{padding:"10px 20px",background:"#6a1b9a",color:"#fff",border:"none",borderRadius:"8px",cursor:"pointer",fontWeight:"bold"},children:"Close"})})]})})};let v,k;const w=new WeakMap,S=new WeakMap,N=new WeakMap,j=new WeakMap,D=new WeakMap;let A={get(e,t,o){if(e instanceof IDBTransaction){if("done"===t)return S.get(e);if("objectStoreNames"===t)return e.objectStoreNames||N.get(e);if("store"===t)return o.objectStoreNames[1]?void 0:o.objectStore(o.objectStoreNames[0])}return T(e[t])},set:(e,t,o)=>(e[t]=o,!0),has:(e,t)=>e instanceof IDBTransaction&&("done"===t||"store"===t)||t in e};function E(e){return e!==IDBDatabase.prototype.transaction||"objectStoreNames"in IDBTransaction.prototype?(k||(k=[IDBCursor.prototype.advance,IDBCursor.prototype.continue,IDBCursor.prototype.continuePrimaryKey])).includes(e)?function(){for(var t=arguments.length,o=new Array(t),n=0;n<t;n++)o[n]=arguments[n];return e.apply(M(this),o),T(w.get(this))}:function(){for(var t=arguments.length,o=new Array(t),n=0;n<t;n++)o[n]=arguments[n];return T(e.apply(M(this),o))}:function(t){for(var o=arguments.length,n=new Array(o>1?o-1:0),a=1;a<o;a++)n[a-1]=arguments[a];const r=e.call(M(this),t,...n);return N.set(r,t.sort?t.sort():[t]),T(r)}}function I(e){return"function"===typeof e?E(e):(e instanceof IDBTransaction&&function(e){if(S.has(e))return;const t=new Promise((t,o)=>{const n=()=>{e.removeEventListener("complete",a),e.removeEventListener("error",r),e.removeEventListener("abort",r)},a=()=>{t(),n()},r=()=>{o(e.error||new DOMException("AbortError","AbortError")),n()};e.addEventListener("complete",a),e.addEventListener("error",r),e.addEventListener("abort",r)});S.set(e,t)}(e),t=e,(v||(v=[IDBDatabase,IDBObjectStore,IDBIndex,IDBCursor,IDBTransaction])).some(e=>t instanceof e)?new Proxy(e,A):e);var t}function T(e){if(e instanceof IDBRequest)return function(e){const t=new Promise((t,o)=>{const n=()=>{e.removeEventListener("success",a),e.removeEventListener("error",r)},a=()=>{t(T(e.result)),n()},r=()=>{o(e.error),n()};e.addEventListener("success",a),e.addEventListener("error",r)});return t.then(t=>{t instanceof IDBCursor&&w.set(t,e)}).catch(()=>{}),D.set(t,e),t}(e);if(j.has(e))return j.get(e);const t=I(e);return t!==e&&(j.set(e,t),D.set(t,e)),t}const M=e=>D.get(e);const P=["get","getKey","getAll","getAllKeys","count"],R=["put","add","delete","clear"],O=new Map;function B(e,t){if(!(e instanceof IDBDatabase)||t in e||"string"!==typeof t)return;if(O.get(t))return O.get(t);const o=t.replace(/FromIndex$/,""),n=t!==o,a=R.includes(o);if(!(o in(n?IDBIndex:IDBObjectStore).prototype)||!a&&!P.includes(o))return;const r=async function(e){const t=this.transaction(e,a?"readwrite":"readonly");let r=t.store;for(var s=arguments.length,c=new Array(s>1?s-1:0),l=1;l<s;l++)c[l-1]=arguments[l];return n&&(r=r.index(c.shift())),(await Promise.all([r[o](...c),a&&t.done]))[0]};return O.set(t,r),r}A=(e=>(0,n.A)((0,n.A)({},e),{},{get:(t,o,n)=>B(t,o)||e.get(t,o,n),has:(t,o)=>!!B(t,o)||e.has(t,o)}))(A);const L={OPEN_CONTRACTS:"open_contracts",CLOSED_INVYGO:"closed_invygo",CLOSED_OTHER:"closed_other",MAINTENANCE:"maintenance",CARS:"cars",METADATA:"metadata"},_=function(e,t){let{blocked:o,upgrade:n,blocking:a,terminated:r}=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};const s=indexedDB.open(e,t),c=T(s);return n&&s.addEventListener("upgradeneeded",e=>{n(T(s.result),e.oldVersion,e.newVersion,T(s.transaction),e)}),o&&s.addEventListener("blocked",e=>o(e.oldVersion,e.newVersion,e)),c.then(e=>{r&&e.addEventListener("close",()=>r()),a&&e.addEventListener("versionchange",e=>a(e.oldVersion,e.newVersion,e))}).catch(()=>{}),c}("dashboard_db",4,{upgrade(e){e.objectStoreNames.contains(L.OPEN_CONTRACTS)||e.createObjectStore(L.OPEN_CONTRACTS,{keyPath:"id",autoIncrement:!0}),e.objectStoreNames.contains(L.CLOSED_INVYGO)||e.createObjectStore(L.CLOSED_INVYGO,{keyPath:"id",autoIncrement:!0}),e.objectStoreNames.contains(L.CLOSED_OTHER)||e.createObjectStore(L.CLOSED_OTHER,{keyPath:"id",autoIncrement:!0}),e.objectStoreNames.contains(L.MAINTENANCE)||e.createObjectStore(L.MAINTENANCE,{keyPath:"id",autoIncrement:!0}),e.objectStoreNames.contains(L.CARS)||e.createObjectStore(L.CARS,{keyPath:"id",autoIncrement:!0}),e.objectStoreNames.contains(L.METADATA)||e.createObjectStore(L.METADATA)}}),W={async clearAll(){const e=(await _).transaction(Object.values(L),"readwrite");await Promise.all([e.objectStore(L.OPEN_CONTRACTS).clear(),e.objectStore(L.CLOSED_INVYGO).clear(),e.objectStore(L.CLOSED_OTHER).clear(),e.objectStore(L.MAINTENANCE).clear(),e.objectStore(L.CARS).clear(),e.objectStore(L.METADATA).clear()]),await e.done},async saveAllData(e){const t=(await _).transaction(Object.values(L),"readwrite"),o=async(e,o)=>{const n=t.objectStore(e);for(const t of o)await n.put(t)};await Promise.all([o(L.OPEN_CONTRACTS,e.openContracts||[]),o(L.CLOSED_INVYGO,e.closedInvygo||[]),o(L.CLOSED_OTHER,e.closedOther||[]),o(L.MAINTENANCE,e.maintenance||[]),o(L.CARS,e.cars||[]),t.objectStore(L.METADATA).put((new Date).toISOString(),"last_sync")]),await t.done},async getAllData(){const e=await _;return{openContracts:await e.getAll(L.OPEN_CONTRACTS),closedInvygo:await e.getAll(L.CLOSED_INVYGO),closedOther:await e.getAll(L.CLOSED_OTHER),maintenance:await e.getAll(L.MAINTENANCE),cars:await e.getAll(L.CARS),lastSync:await e.get(L.METADATA,"last_sync")}}};var F=o(271),X=o(766),H=o.n(X);const V=async e=>{if(!e)throw new Error("Missing Google Sheet URL configuration.");const t=await fetch(e);if(!t.ok)throw new Error("Failed to fetch CSV: ".concat(t.status," ").concat(t.statusText));const o=await t.text();return new Promise(e=>{H().parse(o,{header:!0,skipEmptyLines:!0,complete:t=>e(t.data)})})},z=(e,t)=>t?e.map(e=>{const o={};return Object.keys(e).forEach(n=>{const a=n.trim(),r=t[n]||t[a];r&&(o[r]=e[n]),o[a]=e[n]}),o}):e,Y=async()=>{try{console.log("Starting Dashboard Sync...");const[e,t,o,n,a]=await Promise.all([V(F.go.openContracts),V(F.go.closedInvygo),V(F.go.closedOther),V(F.go.maintenance),V(F.go.cars)]);console.log("Data fetched, applying mappings...");const r=z(e,F.HA.open),s=z(t,F.HA.closed_invygo),c=z(o,F.HA.closed_other);console.log("Saving into dashboard_db...");const l={openContracts:r,closedInvygo:s,closedOther:c,maintenance:n,cars:a};return await W.clearAll(),await W.saveAllData(l),console.log("Dashboard Sync complete."),{success:!0,timestamp:(new Date).toISOString()}}catch(e){return console.error("Dashboard Sync failed:",e),{success:!1,error:e}}},K={ALL:"all",MISMATCH:"mismatch",SWITCHBACK:"switchback",EXPIRED:"expired"},G=(e,t)=>{if(!e.invygoPlate||!t)return"";const o=(0,i.S)(e.invygoPlate),n=t.filter(e=>(0,i.S)(e.Vehicle)===o);if(n.length>0){const e=n.find(e=>!e["Date IN"]||""===e["Date IN"].trim());return e&&e["Damage Details"]||""}return""};function q(){const e=(0,r.Zp)(),{loading:t,error:s,filterMode:c,setFilterMode:l,debouncedSearchTerm:d,setDebouncedSearchTerm:u,filteredData:g,duplicatedContractsInfo:b,maintenanceData:f,isCarExpired:v,getExpiryDate:k,stats:w,searchResults:S,refreshData:N,isSyncing:j,lastSync:D}=function(){const[e,t]=(0,a.useState)([]),[r,s]=(0,a.useState)([]),[c,l]=(0,a.useState)([]),[d,u]=(0,a.useState)([]),[m,g]=(0,a.useState)(!0),[b,f]=(0,a.useState)(null),[y,C]=(0,a.useState)(null),[x,v]=(0,a.useState)(!1),[k,w]=(0,a.useState)(K.ALL),[S,N]=(0,a.useState)(""),j=(0,a.useCallback)(async()=>{try{g(!0);const e=await W.getAllData();t((e.openContracts||[]).map(e=>(0,n.A)((0,n.A)({},e),{},{type:"open"})));const o=[...(e.closedInvygo||[]).map(e=>(0,n.A)((0,n.A)({},e),{},{type:"closed_invygo"})),...(e.closedOther||[]).map(e=>(0,n.A)((0,n.A)({},e),{},{type:"closed_other"}))];s(o),l(e.maintenance||[]),u(e.cars||[]),C(e.lastSync),g(!1),e.openContracts&&0!==e.openContracts.length||e.lastSync||(console.log("DB empty, triggering initial sync via simple refresh call..."),Y().then(e=>{e.success&&W.getAllData().then(e=>{t((e.openContracts||[]).map(e=>(0,n.A)((0,n.A)({},e),{},{type:"open"}))),s([...(e.closedInvygo||[]).map(e=>(0,n.A)((0,n.A)({},e),{},{type:"closed_invygo"})),...(e.closedOther||[]).map(e=>(0,n.A)((0,n.A)({},e),{},{type:"closed_other"}))]),l(e.maintenance||[]),u(e.cars||[]),C(e.lastSync)})}))}catch(e){console.error("Failed to load dashboard data from DB",e),f(e),g(!1)}},[]);(0,a.useEffect)(()=>{j()},[j]);const D=(0,a.useCallback)(e=>{if(!e||!d.length)return!1;const t=(0,i.S)(e),o=d.find(e=>(0,i.S)(e["Plate No"]||e["Plate Number"])===t);if(!o||!o["Reg Exp"])return!1;const n=new Date;n.setHours(0,0,0,0);const a=o["Reg Exp"].split("/");if(3!==a.length)return!1;const r=new Date("".concat(a[2],"-").concat(a[1],"-").concat(a[0]));return!isNaN(r.getTime())&&(r.setHours(23,59,59,999),r<n)},[d]),A=(0,a.useCallback)(e=>{if(!e||!d.length)return null;const t=(0,i.S)(e),o=d.find(e=>(0,i.S)(e["Plate No"]||e["Plate Number"])===t);return o?o["Reg Exp"]:null},[d]),{mismatchRows:E,switchbackRows:I,expiredRows:T}=(0,a.useMemo)(()=>{const t=[],o=[],n=[];return e.forEach(e=>{h(e)&&t.push(e),(e.ejarPlate&&""!==e.ejarPlate.trim()||e.ejarModel&&""!==e.ejarModel.trim())&&h(e)&&p(e,c)&&o.push(e),[e.ejarPlate,e.invygoPlate].filter(Boolean).some(e=>D(e))&&n.push(e)}),{mismatchRows:t,switchbackRows:o,expiredRows:n}},[e,D,c]),M=(0,a.useMemo)(()=>{const t={};e.forEach(e=>{const o=e.invygoPlate||e.ejarPlate,n=(0,i.S)(o);n&&(t[n]||(t[n]=[]),t[n].push({contractNo:e.contractNo,customer:e.customer,plate:o}))});const o={};return Object.keys(t).forEach(e=>{t[e].length>1&&(o[e]=t[e])}),o},[e]),[P,R]=(0,a.useState)({openContractsFromSearch:[],closedContractsFromSearch:[]});(0,a.useEffect)(()=>{if(!S.trim())return void R({openContractsFromSearch:[],closedContractsFromSearch:[]});const t=new Worker(new URL(o.p+o.u(480),o.b)),n=[...e,...r];return t.postMessage({allContracts:n,searchTerm:S}),t.onmessage=e=>{const{openContractsFromSearch:o,closedContractsFromSearch:n}=e.data;R({openContractsFromSearch:o,closedContractsFromSearch:n}),t.terminate()},t.onerror=e=>{console.error("Search Worker Error",e),t.terminate()},()=>{t.terminate()}},[S,e,r]);const O=P,{filteredData:B}=(0,a.useMemo)(()=>k===K.MISMATCH?{filteredData:E}:k===K.SWITCHBACK?{filteredData:I}:k===K.EXPIRED?{filteredData:T}:{filteredData:e},[k,e,E,I,T]);return{loading:m,error:b,filterMode:k,setFilterMode:w,debouncedSearchTerm:S,setDebouncedSearchTerm:N,filteredData:B,duplicatedContractsInfo:M,maintenanceData:c,isCarExpired:D,getExpiryDate:A,stats:{mismatch:E.length,switchback:I.length,expired:T.length,open:e.length},searchResults:O,refreshData:async()=>{try{v(!0);const e=await Y();e.success?await j():f(e.error)}catch(e){f(e)}finally{v(!1)}},isSyncing:x,lastSync:y}}(),[A,E]=(0,a.useState)(""),[I,T]=(0,a.useState)(""),[M,P]=(0,a.useState)(!1),[R,O]=(0,a.useState)(null),[B,L]=(0,a.useState)(()=>{try{const e=localStorage.getItem("contracts_visible_columns");return e?JSON.parse(e):null}catch(e){return null}}),[_,F]=(0,a.useState)({customer:140,contractNo:160,invygoPlate:150,ejarPlate:150,phoneNumber:150,invygoModel:200,ejarModel:200,bookingNumber:150,contractType:140,pickupBranch:160,contact:150,model1:180,dropoffDate:150}),[X,H]=(0,a.useState)(null),[V,z]=(0,a.useState)(!1);(0,a.useEffect)(()=>{B&&localStorage.setItem("contracts_visible_columns",JSON.stringify(B))},[B]);const q=(0,a.useCallback)((e,t)=>{F(o=>(0,n.A)((0,n.A)({},o),{},{[e]:t}))},[]),U=(0,a.useCallback)(e=>{T(e),P(!0),setTimeout(()=>P(!1),3e3)},[]),J=(0,a.useCallback)((e,t)=>{navigator.clipboard.writeText(e).then(()=>{U(t||"Copied!")}).catch(e=>{console.error("Copy failed",e),U("Copy failed")})},[U]),Z={open:["contractNo","bookingNumber","customer","invygoModel","invygoPlate","ejarModel","ejarPlate","phoneNumber","pickupDate","dropoffDate","issue"],master:["contractNo","contractType","bookingNumber","customer","invygoModel","invygoPlate","ejarModel","ejarPlate","model1","phoneNumber","pickupBranch","pickupDate","replacementDate","dropoffDate","contact"],switchback:["contractNo","bookingNumber","customer","invygoModel","invygoPlate","ejarModel","ejarPlate","phoneNumber","pickupDate","dropoffDate"]},$={contractNo:"Contract No.",revenueDate:"Revenue Date",bookingNumber:"Booking Number",customer:"Customer",invygoModel:"Model",invygoPlate:"Plate No.",ejarModel:"Replace Model",ejarPlate:"Rep Plate no.",phoneNumber:"Phone Number",pickupBranch:"Pick-up Branch",pickupDate:"Pick-up Date",replacementDate:"Replacement Date",dropoffDate:"Drop-off Date",model1:"Model (Repeated)",contact:"Contact",contractType:"Contract Type",issue:"Issue"},Q=(0,a.useMemo)(()=>{if(c===K.SWITCHBACK&&""===d.trim())return Z.switchback;if(""===d.trim()&&(c===K.ALL||c===K.MISMATCH))return Z.open;if(0===g.length)return Z.open;const e=new Set(["contractNo"]);return g.forEach(t=>{Object.keys(t).forEach(o=>{t[o]&&e.add(o)})}),d&&e.add("contractType"),Z.master.filter(t=>e.has(t))},[c,d,g]),[ee,te]=(0,a.useState)(1);(0,a.useEffect)(()=>{te(1)},[c,d]);const oe=(0,a.useCallback)(()=>{O(e=>"open"===e?null:"open")},[]),ne=(0,a.useCallback)(()=>{O(e=>"closed"===e?null:"closed")},[]),ae=(0,a.useCallback)(()=>{O(e=>"main"===e?null:"main")},[]),re=(0,a.useCallback)(e=>{e||O(null)},[]),se=(0,a.useCallback)(e=>{H(e),z(!0)},[]),ce=e=>{let{totalRows:t}=e;const o=Math.ceil(t/100);return o<=1?null:(0,m.jsxs)("div",{className:"pagination-controls",style:{display:"flex",justifyContent:"center",alignItems:"center",marginTop:20,gap:15},children:[(0,m.jsx)("button",{className:"control-button",onClick:()=>te(e=>Math.max(e-1,1)),disabled:1===ee,children:"Previous"}),(0,m.jsxs)("span",{style:{fontWeight:"bold"},children:["Page ",ee," of ",o]}),(0,m.jsx)("button",{className:"control-button",onClick:()=>te(e=>Math.min(e+1,o)),disabled:ee===o,children:"Next"})]})};return(0,m.jsxs)("div",{className:"contracts-dashboard",children:[M&&(0,m.jsx)(C,{message:I,onClose:()=>P(!1)}),V&&X&&(0,m.jsx)(x,{contract:X,onClose:()=>{z(!1),H(null)}}),(0,m.jsx)("button",{className:"control-button",onClick:()=>window.location.href="https://moalamir52.github.io/Yelo/",style:{position:"absolute",top:"20px",left:"20px",backgroundColor:"#ffd600",color:"#6a1b9a",fontWeight:"bold",zIndex:1e3},title:"Go back to Yelo Dashboard",children:"\u2b05 Back to Yelo"}),(0,m.jsxs)("div",{className:"dashboard-header",children:[(0,m.jsx)("h1",{children:"Car Rental Dashboard"}),(0,m.jsx)("p",{children:"Contracts & Analysis"})]}),(0,m.jsxs)("div",{className:"controls-container",children:[(0,m.jsx)("button",{className:"control-button",onClick:()=>e("/multi-car"),children:"\ud83d\ude97 Multi-Car Analysis"}),(0,m.jsx)("input",{className:"search-input",placeholder:"\ud83d\udd0d Search (Press Enter)...",value:A,onChange:e=>E(e.target.value),onKeyDown:e=>{"Enter"===e.key&&u(A)}}),(0,m.jsx)("button",{className:"control-button",onClick:N,disabled:j,style:{backgroundColor:"#1976d2",color:"white",border:"none",marginLeft:10},title:D?"Last updated: ".concat(new Date(D).toLocaleString()):"Never updated",children:j?"\u231b Syncing...":"\ud83d\udd04 Refresh DB"})]}),(0,m.jsxs)("div",{className:"filter-buttons",children:[(0,m.jsxs)("button",{className:"control-button ".concat(c===K.ALL?"active":""),onClick:()=>l(K.ALL),children:["All Contracts (",w.open,")"]}),(0,m.jsxs)("button",{className:"control-button ".concat(c===K.MISMATCH?"active":""),onClick:()=>l(K.MISMATCH),children:["Mismatch Only (",w.mismatch,")"]}),(0,m.jsxs)("button",{className:"control-button ".concat(c===K.SWITCHBACK?"active":""),onClick:()=>l(K.SWITCHBACK),children:["Start Switch Back (",w.switchback,")"]}),(0,m.jsxs)("button",{className:"control-button ".concat(c===K.EXPIRED?"active":""),onClick:()=>l(K.EXPIRED),children:["Expired Cars (",w.expired,")"]})]}),t&&(0,m.jsx)("div",{className:"loading-message",children:"Loading data..."}),s&&(0,m.jsx)("div",{className:"error-message",children:s.message||String(s)}),!t&&!s&&(0,m.jsx)(m.Fragment,{children:d?(0,m.jsxs)(m.Fragment,{children:[(0,m.jsx)("div",{className:"search-section-header",style:{margin:"20px auto 10px",color:"#1b5e20",border:"2px solid #2e7d32",borderRadius:"8px",padding:"5px 20px",width:"fit-content",backgroundColor:"#e8f5e9",textAlign:"center"},children:(0,m.jsxs)("h3",{style:{margin:0},children:["\ud83d\udccb Open Contracts (",S.openContractsFromSearch.length,")"]})}),(0,m.jsx)(y,{data:S.openContractsFromSearch,headers:Z.open,visibleColumns:B,columnWidths:_,onColumnResize:q,onToggleColumnMenu:oe,showColumnMenu:"open"===R,setShowColumnMenu:re,setVisibleColumns:L,headerDisplayNames:$,duplicatedContractsInfo:b,maintenanceData:f,isCarExpired:v,getExpiryDate:k,getIssueForRow:G,onCustomerClick:se,onCopy:J}),(0,m.jsx)("div",{className:"search-section-header",style:{margin:"30px auto 10px",color:"#b71c1c",border:"2px solid #c62828",borderRadius:"8px",padding:"5px 20px",width:"fit-content",backgroundColor:"#ffebee",textAlign:"center"},children:(0,m.jsxs)("h3",{style:{margin:0},children:["\ud83d\udd12 Closed Contracts (",S.closedContractsFromSearch.length,")"]})}),(0,m.jsx)(y,{data:S.closedContractsFromSearch,headers:Z.master,visibleColumns:B,columnWidths:_,onColumnResize:q,onToggleColumnMenu:ne,showColumnMenu:"closed"===R,setShowColumnMenu:re,setVisibleColumns:L,headerDisplayNames:$,duplicatedContractsInfo:b,maintenanceData:f,isCarExpired:v,getExpiryDate:k,getIssueForRow:G,onCustomerClick:se,onCopy:J},"table-closed")]}):(0,m.jsxs)(m.Fragment,{children:[(0,m.jsxs)("div",{style:{marginBottom:10,fontWeight:"bold",color:"#6a1b9a",textAlign:"center"},children:["Showing ",g.length," records (Page ",ee,")"]}),(0,m.jsx)(y,{data:(e=>{const t=100*(ee-1);return e.slice(t,t+100)})(g),headers:Q,visibleColumns:B,columnWidths:_,onColumnResize:q,onToggleColumnMenu:ae,showColumnMenu:"main"===R,setShowColumnMenu:re,setVisibleColumns:L,headerDisplayNames:$,duplicatedContractsInfo:b,maintenanceData:f,isCarExpired:v,getExpiryDate:k,getIssueForRow:G,onCustomerClick:se,onCopy:J},"table-main"),(0,m.jsx)(ce,{totalRows:g.length})]})})]})}}}]);
//# sourceMappingURL=513.ce4bd431.chunk.js.map